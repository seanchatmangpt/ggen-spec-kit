name: Kubernetes Deployment

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'k8s/**'
      - 'deployment/helm/**'
      - '.github/workflows/k8s-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: 'Image version to deploy'
        required: true
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  HELM_VERSION: v3.13.3
  KUBECTL_VERSION: v1.29.0

jobs:
  # --------------------------------------------------------------------------
  # Validate Kubernetes manifests
  # --------------------------------------------------------------------------
  validate:
    name: Validate K8s Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Validate Kubernetes manifests
        run: |
          kubectl apply --dry-run=client -f k8s/ || true

      - name: Lint Kubernetes manifests with kubeval
        uses: instrumenta/kubeval-action@master
        with:
          files: k8s/

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Lint Helm chart
        run: |
          helm lint deployment/helm/

      - name: Validate Helm chart
        run: |
          helm template specify deployment/helm/ --debug --dry-run

  # --------------------------------------------------------------------------
  # Deploy to Development
  # --------------------------------------------------------------------------
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development')
    environment:
      name: development
      url: https://specify.dev.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_DEV }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install specify deployment/helm/ \
            --namespace specify \
            --create-namespace \
            --set image.tag=${{ github.event.inputs.version || github.sha }} \
            --set image.registry=${{ env.REGISTRY }} \
            --set ingress.hosts[0].host=specify.dev.example.com \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/specify-cli -n specify --timeout=5m
          kubectl get all -n specify

  # --------------------------------------------------------------------------
  # Deploy to Staging
  # --------------------------------------------------------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://specify.staging.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install specify deployment/helm/ \
            --namespace specify \
            --create-namespace \
            --values deployment/helm/values-staging.yaml \
            --set image.tag=${{ github.event.inputs.version || github.sha }} \
            --set image.registry=${{ env.REGISTRY }} \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/specify-cli -n specify --timeout=5m
          kubectl get all -n specify

      - name: Run smoke tests
        run: |
          kubectl run smoke-test --rm -i --restart=Never \
            --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.version || github.sha }} \
            --namespace=specify \
            -- specify --version

  # --------------------------------------------------------------------------
  # Deploy to Production (manual approval required)
  # --------------------------------------------------------------------------
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://specify.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PROD }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Deploy with Helm (Blue-Green)
        run: |
          # Deploy green version
          helm upgrade --install specify-green deployment/helm/ \
            --namespace specify \
            --create-namespace \
            --values deployment/helm/values-production.yaml \
            --set image.tag=${{ github.event.inputs.version }} \
            --set image.registry=${{ env.REGISTRY }} \
            --set fullnameOverride=specify-green \
            --wait \
            --timeout 10m

      - name: Verify green deployment
        run: |
          kubectl rollout status deployment/specify-green -n specify --timeout=5m

      - name: Run production smoke tests
        run: |
          kubectl run prod-smoke-test --rm -i --restart=Never \
            --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.version }} \
            --namespace=specify \
            -- specify --version

      - name: Switch traffic to green (manual step)
        run: |
          echo "Manual approval required to switch traffic"
          echo "Run: kubectl patch service specify -n specify -p '{\"spec\":{\"selector\":{\"app\":\"specify-green\"}}}'"

      - name: Cleanup blue deployment
        if: success()
        run: |
          helm uninstall specify-blue -n specify || true

  # --------------------------------------------------------------------------
  # Rollback deployment
  # --------------------------------------------------------------------------
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure()
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets[format('KUBE_CONFIG_{0}', github.event.inputs.environment)] }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Rollback Helm release
        run: |
          helm rollback specify -n specify

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "Deployment rollback triggered for ${{ github.event.inputs.environment }}",
              attachments: [{
                color: 'danger',
                text: `Rollback executed for ${process.env.AS_REPO}`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
