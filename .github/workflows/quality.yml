name: Quality Gates

# Lean Six Sigma quality enforcement on every push and PR
# Zero-defect standard: Ruff, MyPy, Bandit, 50%+ coverage

permissions:
  contents: read

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  PYTHON_VERSION_DEFAULT: "3.12"

jobs:
  # ============================================================================
  # Job 1: Quality - Lint, Format, Type Check, Security
  # ============================================================================
  quality:
    name: Quality Checks (Ruff, MyPy, Bandit)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
        run: uv python install ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install dependencies
        run: uv sync --group dev

      - name: Ruff lint check
        run: uv run ruff check src/ tests/

      - name: Ruff format check
        run: uv run ruff format --check src/ tests/

      - name: MyPy type check
        run: uv run mypy src/ tests/

      - name: Bandit security scan
        run: |
          uv pip install bandit
          uv run bandit -r src/ -ll -f json -o reports/bandit.json || true
          uv run bandit -r src/ -ll

      - name: Upload Bandit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: reports/bandit.json
          retention-days: 30

  # ============================================================================
  # Job 2: Test - Unit, Integration with Coverage
  # ============================================================================
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv sync --group dev
          uv sync --group all

      - name: Run pytest with coverage
        run: |
          uv run pytest tests/ \
            --cov=src/specify_cli \
            --cov-report=term-missing \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=html:reports/coverage \
            --cov-fail-under=50 \
            --junitxml=reports/junit.xml \
            -v

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          files: ./reports/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            reports/junit.xml
            reports/coverage.xml
            reports/coverage/
          retention-days: 30

  # ============================================================================
  # Job 3: Integration - Docker, Testcontainers
  # ============================================================================
  integration:
    name: Integration Tests (Docker)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
        run: uv python install ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install dependencies
        run: |
          uv sync --group dev
          uv pip install testcontainers

      - name: Run integration tests
        run: |
          uv run pytest tests/integration/ \
            -m integration \
            -v \
            --tb=short \
            --junitxml=reports/integration-junit.xml

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-results
          path: reports/integration-junit.xml
          retention-days: 30

  # ============================================================================
  # Summary Job (Optional: All checks passed)
  # ============================================================================
  quality-summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [quality, test, integration]
    if: always()

    steps:
      - name: Check quality gate status
        run: |
          echo "Quality checks: ${{ needs.quality.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Integration: ${{ needs.integration.result }}"

          if [ "${{ needs.quality.result }}" != "success" ]; then
            echo "❌ Quality checks failed"
            exit 1
          fi

          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ Tests failed"
            exit 1
          fi

          if [ "${{ needs.integration.result }}" != "success" ]; then
            echo "❌ Integration tests failed"
            exit 1
          fi

          echo "✅ All quality gates passed!"
