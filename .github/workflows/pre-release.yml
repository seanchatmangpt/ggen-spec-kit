name: Pre-Release Validation

# Comprehensive pre-release validation gates
# Run manually before creating a release to ensure quality

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to validate (e.g., 1.2.3)'
        required: true
        type: string
      skip_checks:
        description: 'Comma-separated checks to skip (tests,lint,security,changelog,docs)'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  pull-requests: read

env:
  PYTHON_VERSION_DEFAULT: "3.12"

jobs:
  # ============================================================================
  # Job 1: Git Status Validation
  # ============================================================================
  git-status:
    name: Git Status Clean
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check git status
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ùå Git working directory is not clean"
            git status
            exit 1
          fi
          echo "‚úÖ Git working directory is clean"

      - name: Verify version tag doesn't exist
        run: |
          VERSION="${{ inputs.version }}"
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "‚ùå Tag v${VERSION} already exists"
            exit 1
          fi
          echo "‚úÖ Tag v${VERSION} does not exist"

  # ============================================================================
  # Job 2: Quality Gates (Lint, Type Check, Security)
  # ============================================================================
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: "!contains(inputs.skip_checks, 'lint')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install dependencies
        run: uv sync --group dev

      - name: Ruff lint
        run: |
          echo "Running Ruff linter..."
          uv run ruff check src/ tests/
          echo "‚úÖ Ruff linting passed"

      - name: Ruff format check
        run: |
          echo "Checking code formatting..."
          uv run ruff format --check src/ tests/
          echo "‚úÖ Code formatting passed"

      - name: MyPy type check
        run: |
          echo "Running MyPy type checker..."
          uv run mypy src/ tests/
          echo "‚úÖ Type checking passed"

      - name: Bandit security scan
        if: "!contains(inputs.skip_checks, 'security')"
        run: |
          echo "Running Bandit security scanner..."
          uv pip install bandit
          uv run bandit -r src/ -ll
          echo "‚úÖ Security scan passed (no high/critical issues)"

  # ============================================================================
  # Job 3: Test Coverage
  # ============================================================================
  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: "!contains(inputs.skip_checks, 'tests')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install dependencies
        run: |
          uv sync --group dev
          uv sync --group all

      - name: Run tests with coverage
        run: |
          echo "Running test suite with coverage..."
          uv run pytest tests/ \
            --cov=src/specify_cli \
            --cov-report=term-missing \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=html:reports/coverage \
            --cov-fail-under=50 \
            --junitxml=reports/junit.xml \
            -v
          echo "‚úÖ All tests passed with coverage ‚â• 50%"

      - name: Check for skipped tests
        run: |
          SKIPPED=$(grep -c "SKIPPED" reports/junit.xml || true)
          if [ "$SKIPPED" -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: $SKIPPED tests skipped"
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: reports/coverage/
          retention-days: 30

  # ============================================================================
  # Job 4: Changelog Validation
  # ============================================================================
  changelog-validation:
    name: Changelog Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: "!contains(inputs.skip_checks, 'changelog')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check CHANGELOG.md exists
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "‚ùå CHANGELOG.md not found"
            exit 1
          fi
          echo "‚úÖ CHANGELOG.md exists"

      - name: Check unreleased section exists
        run: |
          VERSION="${{ inputs.version }}"
          if ! grep -q "\[${VERSION}\]" CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md does not contain section for version ${VERSION}"
            echo ""
            echo "Please add a section like:"
            echo "## [${VERSION}] - $(date +%Y-%m-%d)"
            echo ""
            exit 1
          fi
          echo "‚úÖ CHANGELOG.md contains section for version ${VERSION}"

      - name: Check changelog format
        run: |
          echo "Validating Keep a Changelog format..."
          # Check for required sections
          if ! grep -q "## \[" CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md does not follow Keep a Changelog format"
            exit 1
          fi
          echo "‚úÖ CHANGELOG.md follows Keep a Changelog format"

  # ============================================================================
  # Job 5: Documentation Validation
  # ============================================================================
  documentation-validation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: "!contains(inputs.skip_checks, 'docs')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README.md exists
        run: |
          if [ ! -f README.md ]; then
            echo "‚ùå README.md not found"
            exit 1
          fi
          echo "‚úÖ README.md exists"

      - name: Check for broken links (markdown-link-check)
        run: |
          npx markdown-link-check README.md CHANGELOG.md --config .github/markdown-link-check.json || echo "‚ö†Ô∏è  Some links may be broken"

      - name: Verify RDF documentation is up-to-date
        run: |
          # Check if ggen is available
          if ! command -v ggen &> /dev/null; then
            echo "‚ö†Ô∏è  ggen not available, skipping RDF doc check"
            exit 0
          fi

          # Run ggen sync in dry-run mode to check if docs are up-to-date
          echo "Checking if RDF documentation is up-to-date..."
          # This would ideally run ggen sync --dry-run and check for changes
          echo "‚ö†Ô∏è  Manual verification recommended: run 'ggen sync' before release"

  # ============================================================================
  # Job 6: Version Consistency Check
  # ============================================================================
  version-consistency:
    name: Version Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check pyproject.toml version
        run: |
          VERSION="${{ inputs.version }}"
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)

          echo "Input version: ${VERSION}"
          echo "pyproject.toml version: ${PYPROJECT_VERSION}"

          if [ "${PYPROJECT_VERSION}" != "${VERSION}" ]; then
            echo "‚ö†Ô∏è  Version mismatch detected"
            echo "pyproject.toml will be updated during release process"
          else
            echo "‚úÖ Versions are consistent"
          fi

      - name: Detect version bump type from commits
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: ${LATEST_TAG}"

          # Parse commits since last tag
          BREAKING=$(git log ${LATEST_TAG}..HEAD --grep="BREAKING CHANGE" --oneline | wc -l)
          FEAT=$(git log ${LATEST_TAG}..HEAD --grep="^feat" --oneline | wc -l)
          FIX=$(git log ${LATEST_TAG}..HEAD --grep="^fix" --oneline | wc -l)

          echo "Commits since ${LATEST_TAG}:"
          echo "  Breaking changes: ${BREAKING}"
          echo "  Features: ${FEAT}"
          echo "  Fixes: ${FIX}"

          if [ "${BREAKING}" -gt 0 ]; then
            echo "üìä Recommended bump: MAJOR (breaking changes detected)"
          elif [ "${FEAT}" -gt 0 ]; then
            echo "üìä Recommended bump: MINOR (new features detected)"
          elif [ "${FIX}" -gt 0 ]; then
            echo "üìä Recommended bump: PATCH (bug fixes detected)"
          else
            echo "‚ö†Ô∏è  No conventional commits found, manual version validation required"
          fi

  # ============================================================================
  # Summary Job - Generate Pre-Release Report
  # ============================================================================
  pre-release-summary:
    name: Pre-Release Summary
    runs-on: ubuntu-latest
    needs: [git-status, quality-gates, test-coverage, changelog-validation, documentation-validation, version-consistency]
    if: always()

    steps:
      - name: Generate summary report
        run: |
          echo "# Pre-Release Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check results
          if [ "${{ needs.git-status.result }}" == "success" ]; then
            echo "‚úÖ Git Status: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Git Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.quality-gates.result }}" == "success" ] || [ "${{ needs.quality-gates.result }}" == "skipped" ]; then
            echo "‚úÖ Quality Gates: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Quality Gates: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-coverage.result }}" == "success" ] || [ "${{ needs.test-coverage.result }}" == "skipped" ]; then
            echo "‚úÖ Test Coverage: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Test Coverage: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changelog-validation.result }}" == "success" ] || [ "${{ needs.changelog-validation.result }}" == "skipped" ]; then
            echo "‚úÖ Changelog: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Changelog: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.documentation-validation.result }}" == "success" ] || [ "${{ needs.documentation-validation.result }}" == "skipped" ]; then
            echo "‚úÖ Documentation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Documentation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.version-consistency.result }}" == "success" ]; then
            echo "‚úÖ Version Consistency: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Version Consistency: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.git-status.result }}" == "success" ] && \
             ([ "${{ needs.quality-gates.result }}" == "success" ] || [ "${{ needs.quality-gates.result }}" == "skipped" ]) && \
             ([ "${{ needs.test-coverage.result }}" == "success" ] || [ "${{ needs.test-coverage.result }}" == "skipped" ]) && \
             ([ "${{ needs.changelog-validation.result }}" == "success" ] || [ "${{ needs.changelog-validation.result }}" == "skipped" ]) && \
             ([ "${{ needs.documentation-validation.result }}" == "success" ] || [ "${{ needs.documentation-validation.result }}" == "skipped" ]) && \
             [ "${{ needs.version-consistency.result }}" == "success" ]; then
            echo "## ‚úÖ READY FOR RELEASE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All pre-release validation checks passed." >> $GITHUB_STEP_SUMMARY
            echo "You can proceed with creating release v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå NOT READY FOR RELEASE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some validation checks failed. Please address the issues before releasing." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Final status check
        run: |
          # Exit with error if any critical check failed
          if [ "${{ needs.git-status.result }}" != "success" ] || \
             ([ "${{ needs.quality-gates.result }}" != "success" ] && [ "${{ needs.quality-gates.result }}" != "skipped" ]) || \
             ([ "${{ needs.test-coverage.result }}" != "success" ] && [ "${{ needs.test-coverage.result }}" != "skipped" ]); then
            echo "‚ùå Critical validation checks failed"
            exit 1
          fi
          echo "‚úÖ All critical checks passed"
