# ==============================================================================
# Default values for specify-cli Helm chart
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.
# ==============================================================================

# ------------------------------------------------------------------------------
# Global settings
# ------------------------------------------------------------------------------
global:
  # Image registry to use for all images
  imageRegistry: ""

  # Image pull secrets
  imagePullSecrets: []
  #   - name: myRegistryKeySecretName

  # Storage class for persistent volumes
  storageClass: "standard"

# ------------------------------------------------------------------------------
# Image configuration
# ------------------------------------------------------------------------------
image:
  registry: docker.io
  repository: specify-cli
  tag: "0.0.25"
  pullPolicy: IfNotPresent
  pullSecrets: []

# ------------------------------------------------------------------------------
# Deployment configuration
# ------------------------------------------------------------------------------
replicaCount: 3

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# ------------------------------------------------------------------------------
# Service configuration
# ------------------------------------------------------------------------------
service:
  type: ClusterIP
  port: 8080
  metricsPort: 8081
  annotations: {}
  sessionAffinity: ClientIP

# ------------------------------------------------------------------------------
# Ingress configuration
# ------------------------------------------------------------------------------
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "10"
  hosts:
    - host: specify.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: specify-tls-cert
      hosts:
        - specify.example.com

# ------------------------------------------------------------------------------
# Resource limits and requests
# ------------------------------------------------------------------------------
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 256Mi

# ------------------------------------------------------------------------------
# Autoscaling configuration
# ------------------------------------------------------------------------------
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
        - type: Pods
          value: 2
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 4
          periodSeconds: 30

# ------------------------------------------------------------------------------
# Pod Disruption Budget
# ------------------------------------------------------------------------------
podDisruptionBudget:
  enabled: true
  minAvailable: 2
  # maxUnavailable: 1

# ------------------------------------------------------------------------------
# Security context
# ------------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# ------------------------------------------------------------------------------
# Probes configuration
# ------------------------------------------------------------------------------
livenessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 30
  timeoutSeconds: 10
  successThreshold: 1
  failureThreshold: 3
  exec:
    command:
      - specify
      - --version

readinessProbe:
  enabled: true
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3
  exec:
    command:
      - specify
      - --version

startupProbe:
  enabled: true
  initialDelaySeconds: 0
  periodSeconds: 5
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 30
  exec:
    command:
      - specify
      - --version

# ------------------------------------------------------------------------------
# Environment variables
# ------------------------------------------------------------------------------
env:
  # Application configuration
  LOG_LEVEL: "INFO"
  ENVIRONMENT: "production"
  PYTHONUNBUFFERED: "1"

  # OpenTelemetry configuration
  OTEL_SERVICE_NAME: "specify-cli"
  OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"
  OTEL_TRACES_EXPORTER: "otlp"
  OTEL_METRICS_EXPORTER: "otlp"
  OTEL_LOGS_EXPORTER: "otlp"

  # Feature flags
  ENABLE_TELEMETRY: "true"
  ENABLE_METRICS: "true"
  ENABLE_TRACING: "true"

# ------------------------------------------------------------------------------
# Secrets (use external secret management in production)
# ------------------------------------------------------------------------------
secrets:
  # Database credentials
  DATABASE_USER: "specify"
  DATABASE_PASSWORD: "changeme-in-production"

  # Redis password
  REDIS_PASSWORD: ""

# ------------------------------------------------------------------------------
# Persistent storage
# ------------------------------------------------------------------------------
persistence:
  enabled: true
  storageClass: "standard"
  accessMode: ReadWriteOnce
  size: 10Gi
  annotations: {}

# ------------------------------------------------------------------------------
# Database configuration (PostgreSQL)
# ------------------------------------------------------------------------------
postgresql:
  enabled: true
  auth:
    username: specify
    password: specify
    database: specify
  primary:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# ------------------------------------------------------------------------------
# Redis configuration
# ------------------------------------------------------------------------------
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      size: 5Gi
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

# ------------------------------------------------------------------------------
# Monitoring configuration
# ------------------------------------------------------------------------------
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
  prometheusRule:
    enabled: true

# ------------------------------------------------------------------------------
# Network Policy
# ------------------------------------------------------------------------------
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress

# ------------------------------------------------------------------------------
# Service Account
# ------------------------------------------------------------------------------
serviceAccount:
  create: true
  annotations: {}
  name: "specify-sa"
  automountServiceAccountToken: true

# ------------------------------------------------------------------------------
# RBAC configuration
# ------------------------------------------------------------------------------
rbac:
  create: true

# ------------------------------------------------------------------------------
# Node selector
# ------------------------------------------------------------------------------
nodeSelector: {}

# ------------------------------------------------------------------------------
# Tolerations
# ------------------------------------------------------------------------------
tolerations:
  - key: "node.kubernetes.io/not-ready"
    operator: "Exists"
    effect: "NoExecute"
    tolerationSeconds: 300
  - key: "node.kubernetes.io/unreachable"
    operator: "Exists"
    effect: "NoExecute"
    tolerationSeconds: 300

# ------------------------------------------------------------------------------
# Affinity
# ------------------------------------------------------------------------------
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - specify-cli
          topologyKey: kubernetes.io/hostname

# ------------------------------------------------------------------------------
# Init containers
# ------------------------------------------------------------------------------
initContainers:
  waitForPostgres:
    enabled: true
    image: busybox:1.36
  waitForRedis:
    enabled: true
    image: busybox:1.36

# ------------------------------------------------------------------------------
# Extra labels
# ------------------------------------------------------------------------------
extraLabels: {}

# ------------------------------------------------------------------------------
# Extra annotations
# ------------------------------------------------------------------------------
extraAnnotations: {}

# ------------------------------------------------------------------------------
# Pod labels
# ------------------------------------------------------------------------------
podLabels: {}

# ------------------------------------------------------------------------------
# Pod annotations
# ------------------------------------------------------------------------------
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"
